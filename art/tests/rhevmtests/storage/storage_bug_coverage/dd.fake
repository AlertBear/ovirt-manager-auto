#!/bin/sh
# Detect read from inbox and simulate a dd error
# dd if=/rhev/data-center/pool-uuid/mastersd/dom_md/inbox iflag=direct,fullblock count=1
#
# To start simulating errors do:
#
#   touch /tmp/dd.error
#
# To stop simulating errors do:
#
#   rm /tmp/dd.error
#
# Installation:
#
#   cp dd.fake /usr/bin/dd.fake
#   cd /usr/bin
#   chmod +x dd.fake
#   ln dd dd.real
#   ln -sf dd.fake dd
#
# Uinstalling:
#
#   ln -f dd.real dd
#   rm dd.fake dd.real

if echo "$1" | egrep -q "^if=/rhev/data-center/.+/mastersd/dom_md/inbox$" >/dev/null 2>&1; then
    if [ -f "/tmp/dd.error" ]; then
        exit 1
    fi
fi

exec /usr/bin/dd.real "$@"

